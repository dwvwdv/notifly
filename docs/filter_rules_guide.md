# Webhook 進階條件過濾功能使用指南

## 功能概述

進階條件過濾功能允許您為每個應用程式設置自定義的過濾規則，只在特定條件下發送 webhook，並從通知內容中提取結構化資訊。

## 主要特性

1. **條件過濾**：只在滿足特定條件時發送 webhook
2. **Placeholder 提取**：從通知內容中提取特定資訊（如金額、貨幣等）
3. **多規則支持**：每個應用可設置多個過濾規則
4. **靈活匹配**：支持多種匹配運算符和正則表達式

## 使用流程

### 1. 進入進階條件配置

1. 開啟 Hookfy 應用
2. 進入「Settings」→「Select Apps」
3. 找到您要配置的應用
4. 點擊右側的「過濾器」圖標（橙色）

### 2. 創建過濾規則

#### 範例：幣安儲值通知過濾

假設幣安會發送以下通知：
- **標題**: USDT 儲值處理中
- **內容**: 您儲值的 633.98USDT 處理中。如果您對此項活動沒有印象，請立即聯絡我們。

**配置步驟：**

1. 點擊「新增規則」
2. 設定規則名稱：`幣安儲值通知`
3. 添加匹配條件：
   - 條件 1：
     - 字段：`內容`
     - 運算符：`包含`
     - 值：`您儲值`
   - 條件 2：
     - 字段：`應用名稱`
     - 運算符：`等於`
     - 值：`幣安`

4. 添加 Placeholder 提取器：
   - 提取器 1（提取金額和貨幣）：
     - 名稱：`amount`
     - 來源字段：`內容`
     - 正則表達式：`(\d+\.?\d*)(USDT|BTC|ETH)`
     - 捕獲組索引：`1`（提取數字部分）

   - 提取器 2（提取貨幣）：
     - 名稱：`currency`
     - 來源字段：`內容`
     - 正則表達式：`(\d+\.?\d*)(USDT|BTC|ETH)`
     - 捕獲組索引：`2`（提取貨幣部分）

5. 點擊右上角「✓」儲存

### 3. Webhook Payload 格式

當通知匹配規則後，webhook payload 會包含提取的字段：

```json
{
  "type": "notification",
  "timestamp": "2025-12-02T10:30:45.123Z",
  "data": {
    "packageName": "com.binance.dev",
    "appName": "幣安",
    "title": "USDT 儲值處理中",
    "text": "您儲值的 633.98USDT 處理中。如果您對此項活動沒有印象，請立即聯絡我們。",
    "subText": "",
    "bigText": "您儲值的 633.98USDT 處理中。如果您對此項活動沒有印象，請立即聯絡我們。",
    "timestamp": 1733137845123,
    "timestampISO": "2025-12-02T10:30:45.123Z",
    "extractedFields": {
      "amount": "633.98",
      "currency": "USDT"
    }
  }
}
```

## 支援的匹配運算符

| 運算符 | 說明 | 範例 |
|--------|------|------|
| `包含` | 字段包含指定文字 | 內容包含 "儲值" |
| `不包含` | 字段不包含指定文字 | 內容不包含 "測試" |
| `等於` | 字段完全等於指定文字 | 標題等於 "付款成功" |
| `不等於` | 字段不等於指定文字 | 標題不等於 "廣告" |
| `開頭是` | 字段以指定文字開頭 | 標題開頭是 "重要通知" |
| `結尾是` | 字段以指定文字結尾 | 內容結尾是 "已完成" |
| `匹配（正則）` | 使用正則表達式匹配 | 內容匹配 `\d+.*USDT` |

## 支援的字段

- `title`（標題）：通知標題
- `text`（內容）：通知主要內容
- `bigText`（完整內容）：通知的完整內容
- `subText`（副標題）：通知副標題
- `appName`（應用名稱）：應用的顯示名稱
- `packageName`（包名）：應用的包名

## 正則表達式提取範例

### 範例 1：提取金額
**文本**: "您的帳戶收到 1,234.56 元"
**正則**: `([\d,]+\.?\d*)\s*元`
**結果**: `1,234.56`

### 範例 2：提取多個部分
**文本**: "轉帳 500 USDT 到 0x1234...5678"
**正則**: `轉帳\s+(\d+)\s+(\w+)\s+到\s+(.+)`
- 組 1: `500`（金額）
- 組 2: `USDT`（貨幣）
- 組 3: `0x1234...5678`（地址）

### 範例 3：提取時間
**文本**: "交易將於 2025-12-02 15:30 完成"
**正則**: `(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})`
**結果**: `2025-12-02 15:30`

## 注意事項

1. **條件邏輯**：同一規則內的所有條件必須同時滿足（AND 邏輯）
2. **規則順序**：系統會依序檢查規則，第一個匹配的規則會被應用
3. **無規則**：如果應用未設置任何規則，所有通知都會發送
4. **過濾狀態**：被過濾的通知會在數據庫中標記為 "filtered" 狀態
5. **正則語法**：使用標準的正則表達式語法（Regex）

## 常見使用場景

### 場景 1：只發送交易成功通知
```
條件：標題包含 "成功"
```

### 場景 2：只發送大額交易
```
條件：內容匹配（正則） "\d{4,}"  # 四位數以上
提取器：amount = "(\d+)"
```

### 場景 3：過濾廣告通知
```
條件：標題不包含 "廣告"
條件：標題不包含 "優惠"
```

### 場景 4：特定類型通知
```
條件：標題包含 "安全"
條件：內容包含 "驗證碼"
提取器：code = "驗證碼[：:]\s*(\d+)"
```

## 疑難排解

### 問題：規則不生效
- 確認規則已啟用（開關為開啟狀態）
- 檢查條件是否正確配置
- 確認應用已啟用監測

### 問題：提取器無法提取內容
- 檢查正則表達式是否正確
- 確認捕獲組索引是否正確（從 1 開始）
- 測試正則表達式是否匹配目標文本

### 問題：所有通知都被過濾
- 檢查條件是否過於嚴格
- 確認字段名稱是否正確
- 考慮添加更寬鬆的條件

## 技術實現

此功能在 Kotlin 原生層實現條件匹配，確保：
- ✅ 即使 Flutter 應用未運行也能正常工作
- ✅ 高效的正則表達式匹配
- ✅ 最小化性能影響
- ✅ 所有過濾在本地完成，無需網絡請求

## 版本歷史

- **v1.1.0**：新增進階條件過濾功能
  - 支援多條件匹配
  - 支援 Placeholder 提取
  - 支援正則表達式
  - 原生層實現，高效穩定
